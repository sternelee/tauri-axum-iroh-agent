# Iroh P2P 聊天应用使用指南

这是一个基于 Iroh 的点对点聊天应用，支持在终端中进行实时聊天。

## 功能特性

- 🔗 点对点连接，无需中央服务器
- 💬 实时聊天消息传输
- 🎫 基于邀请码的房间加入机制
- 👥 多用户支持
- 🔒 基于 Iroh Gossip 协议的安全传输

## 当前状态

✅ **可用功能:**
- 命令行界面和参数解析
- 聊天室创建和加入逻辑
- 消息序列化和反序列化
- 基本的输入处理

⚠️ **暂时禁用的功能:**
- 真正的 P2P 网络连接 (由于 iroh API 重大变化)
- 实时消息传输 (等待 API 修复)
- 文件传输功能
- 高级聊天功能

## 技术说明

由于 iroh 库从 0.28 升级到 0.90 版本，API 结构发生了重大变化：

1. `iroh::node::Node` 模块结构改变
2. `iroh-gossip` 的 API 接口完全重构
3. 事件处理和订阅机制更新

当前版本提供了完整的命令行界面和消息处理框架，一旦 iroh API 稳定，可以快速恢复网络功能。

## 安装和运行

### 编译项目

```bash
cd iroh-node
cargo build --release
```

### 运行应用

#### 方式1: 使用主程序

```bash
# 创建新聊天室
cargo run -- --name "张三" open

# 加入现有聊天室
cargo run -- --name "李四" join <邀请码>
```

#### 方式2: 使用最小化示例 (推荐用于测试)

```bash
# 创建聊天室
cargo run --example minimal_chat -- --name "张三" create

# 加入聊天室 (使用显示的主题ID)
cargo run --example minimal_chat -- --name "李四" join <主题ID>
```

#### 方式3: 基本节点测试

```bash
# 启动节点
cargo run --example basic_test -- start

# 显示节点信息
cargo run --example basic_test -- info
```

## 使用流程

### 1. 创建聊天室

运行创建命令后，应用会：
- 生成一个唯一的聊天室
- 显示邀请码
- 等待其他用户加入

```
=== 聊天室已创建 ===
邀请码: iroh-gossip://AQAAAA...
请将此邀请码分享给其他人加入聊天室
输入消息开始聊天，输入 'quit' 退出
```

### 2. 加入聊天室

其他用户使用邀请码加入：

```bash
cargo run -- --name "用户名" join "iroh-gossip://AQAAAA..."
```

### 3. 开始聊天

- 直接输入消息并按回车发送
- 消息会实时同步到所有连接的用户
- 输入 `quit` 退出聊天室

## 命令行选项

```
iroh-chat [OPTIONS] <COMMAND>

选项:
  -n, --name <NAME>     用户名 [默认: 匿名用户]
  -v, --verbose         详细日志输出
  -h, --help           显示帮助信息

命令:
  open              创建新的聊天室
  join <TICKET>     加入现有聊天室
```

## 示例场景

### 场景1：两人聊天

**用户A (创建者):**
```bash
cargo run -- --name "Alice" open
```

输出：
```
=== 聊天室已创建 ===
邀请码: iroh-gossip://AQAAAA...
>>> Alice 加入了聊天室 (节点: 12345678)
```

**用户B (加入者):**
```bash
cargo run -- --name "Bob" join "iroh-gossip://AQAAAA..."
```

输出：
```
=== 已加入聊天室 ===
>>> Bob 加入了聊天室 (节点: 87654321)
```

**聊天过程:**
```
Alice: 你好！
Bob: 嗨，Alice！
Alice: 这个P2P聊天很酷！
Bob: 确实，没有服务器也能聊天
```

### 场景2：多人群聊

多个用户可以使用同一个邀请码加入同一个聊天室，实现群聊功能。

## 技术细节

- **传输协议**: 基于 Iroh Gossip 协议
- **消息格式**: JSON 序列化
- **连接方式**: 点对点直连
- **消息去重**: 自动处理重复消息
- **节点发现**: 基于邀请码的节点发现机制

## 故障排除

### 常见问题

1. **无法连接到其他节点**
   - 检查网络连接
   - 确保防火墙允许应用通信
   - 验证邀请码是否正确

2. **消息发送失败**
   - 检查是否还有其他节点在线
   - 重新启动应用尝试重连

3. **邀请码无效**
   - 确保邀请码完整复制
   - 检查邀请码是否过期

### 调试模式

使用 `--verbose` 选项启用详细日志：

```bash
cargo run -- --name "调试用户" --verbose open
```

这将显示详细的连接和消息传输信息，有助于诊断问题。

## 安全注意事项

- 当前实现为演示版本，生产环境需要额外的安全措施
- 消息未加密，请勿传输敏感信息
- 建议在可信网络环境中使用

## 扩展功能

可以基于此实现添加更多功能：
- 消息加密
- 文件传输
- 用户身份验证
- 聊天记录保存
- 表情符号支持